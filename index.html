<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Fast Math: Flow Mode</title>
    <style>
      :root {
        --bg-color: #f4f4f9;
        --text-color: #333;
        --accent-color: #007aff;
        --error-color: #ff3b30;
        --keypad-bg: #fff;
      }

      * {
        box-sizing: border-box;
        touch-action: manipulation;
      }

      body {
        margin: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;

        /* FIX 1: Use 100dvh to prevent browser bar from hiding content */
        height: 100dvh;
        overflow: hidden;

        /* FIX 2: Add padding for iPhone 'Home' swipe bar */
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* --- Layout Containers --- */
      #start-screen,
      #game-screen,
      #summary-screen {
        width: 100%;
        max-width: 500px;
        height: 100%;
        display: flex;
        flex-direction: column;
        padding: 20px;
      }

      #game-screen {
        justify-content: flex-start;
      }
      .hidden {
        display: none !important;
      }

      /* --- Header & Timer --- */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        font-size: 1.2rem;
        color: #666;
        height: 50px;
        flex-shrink: 0; /* Prevents header from shrinking */
      }

      #timer {
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        color: var(--text-color);
      }

      /* --- Question Area --- */
      .question-container {
        flex: 1; /* Takes up all available middle space */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;

        /* Responsive Font Sizes */
        font-size: 3.5rem;
        font-weight: 700;
        white-space: nowrap; /* Prevents wrapping */
      }

      /* Smaller font for small phones */
      @media (max-width: 380px) {
        .question-container {
          font-size: 2.8rem;
        }
      }

      .input-display {
        min-height: 4rem;
        color: var(--accent-color);
        margin-top: 10px;
        border-bottom: 3px solid transparent;
      }
      .input-display.active {
        border-bottom: 3px solid #ddd;
      }

      /* --- Keypad (The Main Fixes) --- */
      .keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding-bottom: 10px;
        margin-top: auto; /* Pushes keypad to bottom */

        /* FIX 3: Force width and centering to prevent "skinny" look */
        width: 100%;
        max-width: 380px;
        margin-left: auto;
        margin-right: auto;
      }

      .key {
        background: var(--keypad-bg);
        border: 1px solid #ddd;
        border-radius: 12px;

        /* FIX 4: Use aspect-ratio to make them perfect rectangles, not pills */
        aspect-ratio: 1.5;
        height: auto;

        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        cursor: pointer;
        box-shadow: 0 4px 0px rgba(0, 0, 0, 0.1);
        transition:
          transform 0.05s,
          box-shadow 0.05s;
        user-select: none;
        color: #333;
      }

      .key:active {
        transform: translateY(4px);
        box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        background: #f0f0f0;
      }

      .key-back {
        background-color: #fff0f0;
        color: var(--error-color);
        border-color: #ffcccc;
      }

      /* --- Start & Summary Screens --- */
      #start-screen,
      #summary-screen {
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .hero-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-color);
        margin-bottom: 10px;
      }
      .hero-subtitle {
        font-size: 1.1rem;
        color: #666;
        margin-bottom: 40px;
      }
      .instruction-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 40px;
        text-align: left;
        width: 100%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      }
      .btn-primary {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 20px;
        font-size: 1.5rem;
        font-weight: bold;
        border-radius: 12px;
        cursor: pointer;
        width: 100%;
      }

      .stats-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }
      .stats-table th,
      .stats-table td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .stats-table td.time-col {
        text-align: right;
        font-family: monospace;
      }
      .total-row {
        font-weight: bold;
        font-size: 1.1rem;
        border-top: 2px solid #333;
      }

      /* --- Animations --- */
      @keyframes shake {
        0% {
          transform: translate(1px, 1px);
        }
        50% {
          transform: translate(-1px, 2px);
        }
        100% {
          transform: translate(0, 0);
        }
      }
      @keyframes flash-green {
        0% {
          background: var(--bg-color);
        }
        50% {
          background: rgba(52, 199, 89, 0.2);
        }
        100% {
          background: var(--bg-color);
        }
      }
      .shake-anim {
        animation: shake 0.4s;
        color: var(--error-color);
      }
      .flash-anim {
        animation: flash-green 0.3s;
      }
    </style>
  </head>
  <body id="body-container">
    <div id="start-screen">
      <div class="hero-title">Flow Mode<br />Subtraction</div>
      <div class="hero-subtitle">Range 60 - 100</div>

      <div class="instruction-box">
        <h3>How to play:</h3>
        <ul>
          <li>Solve <strong>10 Questions</strong> as fast as you can.</li>
          <li><strong>No Enter Button:</strong> Just type the answer.</li>
          <li>If the answer is correct, it moves automatically.</li>
        </ul>
      </div>

      <button class="btn-primary" onclick="initGame()">START SESSION</button>
    </div>

    <div id="game-screen" class="hidden">
      <header>
        <div id="progress">Q: 1 / 10</div>
        <div id="timer">00:000</div>
      </header>

      <div class="question-container">
        <div id="problem-text">0 - 0</div>
        <div id="input-display" class="input-display active"></div>
      </div>

      <div class="keypad">
        <div class="key" onclick="handleInput('1')">1</div>
        <div class="key" onclick="handleInput('2')">2</div>
        <div class="key" onclick="handleInput('3')">3</div>
        <div class="key" onclick="handleInput('4')">4</div>
        <div class="key" onclick="handleInput('5')">5</div>
        <div class="key" onclick="handleInput('6')">6</div>
        <div class="key" onclick="handleInput('7')">7</div>
        <div class="key" onclick="handleInput('8')">8</div>
        <div class="key" onclick="handleInput('9')">9</div>
        <div class="key" onclick="handleInput('-')">-</div>
        <div class="key" onclick="handleInput('0')">0</div>
        <div class="key key-back" onclick="handleInput('back')">âŒ«</div>
      </div>
    </div>

    <div id="summary-screen" class="hidden">
      <h2>Session Summary</h2>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Q#</th>
            <th>Problem</th>
            <th>Errors</th>
            <th class="time-col">Time</th>
          </tr>
        </thead>
        <tbody id="stats-body"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3">Total Time</td>
            <td class="time-col" id="total-time-display">00:000</td>
          </tr>
        </tfoot>
      </table>
      <button class="btn-primary" onclick="showStartScreen()">
        HOME / RESTART
      </button>
    </div>

    <script>
      // --- Configuration ---
      const TOTAL_QUESTIONS = 10;
      const RANGE_MIN = 60;
      const RANGE_MAX = 100;

      // --- State ---
      let currentQuestionIdx = 0;
      let sessionResults = [];
      let currentInput = "";
      let currentProblem = {};
      let currentErrors = 0;
      let questionStartTime = 0;
      let timerInterval = null;

      // --- DOM Elements ---
      const ui = {
        startScreen: document.getElementById("start-screen"),
        gameScreen: document.getElementById("game-screen"),
        summaryScreen: document.getElementById("summary-screen"),
        progress: document.getElementById("progress"),
        timer: document.getElementById("timer"),
        problemText: document.getElementById("problem-text"),
        inputDisplay: document.getElementById("input-display"),
        statsBody: document.getElementById("stats-body"),
        totalTimeDisplay: document.getElementById("total-time-display"),
        body: document.getElementById("body-container"),
      };

      function showStartScreen() {
        ui.gameScreen.classList.add("hidden");
        ui.summaryScreen.classList.add("hidden");
        ui.startScreen.classList.remove("hidden");
      }

      function initGame() {
        currentQuestionIdx = 0;
        sessionResults = [];
        ui.startScreen.classList.add("hidden");
        ui.summaryScreen.classList.add("hidden");
        ui.gameScreen.classList.remove("hidden");
        loadNextQuestion();
      }

      function generateRandomNumber(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function loadNextQuestion() {
        if (currentQuestionIdx >= TOTAL_QUESTIONS) {
          endGame();
          return;
        }

        const a = generateRandomNumber(RANGE_MIN, RANGE_MAX);
        const b = generateRandomNumber(RANGE_MIN, RANGE_MAX);

        currentProblem = { a: a, b: b, answer: a - b };

        currentInput = "";
        currentErrors = 0;
        updateInputDisplay();

        ui.problemText.innerText = `${a} - ${b}`;
        ui.progress.innerText = `Q: ${currentQuestionIdx + 1} / ${TOTAL_QUESTIONS}`;

        questionStartTime = performance.now();
        startVisualTimer();
      }

      // --- THE NEW AUTO-CHECK LOGIC ---
      function checkAutoSubmit() {
        if (currentInput === "" || currentInput === "-") return;

        const val = parseInt(currentInput, 10);
        const answerStr = currentProblem.answer.toString();

        // 1. Exact Match -> Success
        if (val === currentProblem.answer) {
          handleCorrect();
        }
        // 2. Length Logic: If input is same length (or longer) than answer
        // AND value is wrong, trigger error immediately.
        else if (currentInput.length >= answerStr.length) {
          // Special case: prevent "0" from erroring if answer is "5" (length 1 vs 1)
          // Actually, for speed math, strict length check is preferred.
          handleIncorrect();
        }
      }

      function handleCorrect() {
        const endTime = performance.now();
        const timeTaken = endTime - questionStartTime;
        stopVisualTimer();

        sessionResults.push({
          questionIndex: currentQuestionIdx + 1,
          problem: `${currentProblem.a} - ${currentProblem.b}`,
          errors: currentErrors,
          time: timeTaken,
        });

        ui.body.classList.add("flash-anim");
        setTimeout(() => ui.body.classList.remove("flash-anim"), 300);

        currentQuestionIdx++;
        loadNextQuestion();
      }

      function handleIncorrect() {
        currentErrors++;

        ui.problemText.classList.add("shake-anim");
        ui.inputDisplay.classList.add("shake-anim");

        // Clear input immediately so they can retry
        currentInput = "";
        updateInputDisplay();

        setTimeout(() => {
          ui.problemText.classList.remove("shake-anim");
          ui.inputDisplay.classList.remove("shake-anim");
        }, 400);
      }

      function endGame() {
        ui.gameScreen.classList.add("hidden");
        ui.summaryScreen.classList.remove("hidden");
        renderStats();
      }

      function handleInput(key) {
        if (key === "back") {
          currentInput = currentInput.slice(0, -1);
        } else if (key === "-") {
          if (currentInput.length === 0) currentInput = "-";
        } else {
          if (currentInput.length < 5) {
            currentInput += key;
          }
        }
        updateInputDisplay();

        // Check correctness immediately after every keypress
        checkAutoSubmit();
      }

      function updateInputDisplay() {
        ui.inputDisplay.innerText = currentInput;
      }

      document.addEventListener("keydown", (e) => {
        if (ui.gameScreen.classList.contains("hidden")) {
          if (e.key === "Enter") {
            if (!ui.startScreen.classList.contains("hidden")) initGame();
            if (!ui.summaryScreen.classList.contains("hidden"))
              showStartScreen();
          }
          return;
        }

        const key = e.key;
        if (isFinite(key)) handleInput(key);
        else if (key === "-") handleInput("-");
        else if (key === "Backspace") handleInput("back");
      });

      function startVisualTimer() {
        if (timerInterval) cancelAnimationFrame(timerInterval);
        const update = () => {
          const now = performance.now();
          const diff = now - questionStartTime;
          ui.timer.innerText = formatTime(diff);
          timerInterval = requestAnimationFrame(update);
        };
        timerInterval = requestAnimationFrame(update);
      }

      function stopVisualTimer() {
        if (timerInterval) cancelAnimationFrame(timerInterval);
      }

      function formatTime(ms) {
        const seconds = Math.floor(ms / 1000);
        const milliseconds = Math.floor(ms % 1000);
        return `${seconds.toString().padStart(2, "0")}:${milliseconds.toString().padStart(3, "0")}`;
      }

      function renderStats() {
        ui.statsBody.innerHTML = "";
        let totalTime = 0;
        sessionResults.forEach((res) => {
          totalTime += res.time;
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${res.questionIndex}</td>
                    <td>${res.problem}</td>
                    <td style="color: ${res.errors > 0 ? "var(--error-color)" : "inherit"}">${res.errors}</td>
                    <td class="time-col">${formatTime(res.time)}</td>
                `;
          ui.statsBody.appendChild(tr);
        });
        ui.totalTimeDisplay.innerText = formatTime(totalTime);
      }
    </script>
  </body>
</html>
